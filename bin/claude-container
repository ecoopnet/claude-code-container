#!/bin/bash

# Get the project root directory (parent of bin directory)
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || realpath "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")")/.." && pwd)"

# Check if script is executed via symlink and show hint
show_symlink_hint() {
    if [ ! -L "$0" ]; then
        local script_name=$(basename "$0")
        if [ "$LANG_CODE" = "ja" ]; then
            echo "ðŸ’¡ ãƒ’ãƒ³ãƒˆ: ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã§$PATHã«è¿½åŠ ã™ã‚‹ã¨ã€ã©ã“ã‹ã‚‰ã§ã‚‚å®Ÿè¡Œã§ãã¦ä¾¿åˆ©ã§ã™:"
            echo "   sudo ln -s \"$(readlink -f "$0")\" /usr/local/bin/$script_name"
            echo "   ã¾ãŸã¯ã€ãŠå¥½ã¿ã®å ´æ‰€ã«:"
            echo "   ln -s \"$(readlink -f "$0")\" ~/.local/bin/$script_name"
            echo ""
        else
            echo "ðŸ’¡ Hint: Adding this script to your PATH via symlink makes it convenient to run from anywhere:"
            echo "   sudo ln -s \"$(readlink -f "$0")\" /usr/local/bin/$script_name"
            echo "   Or to your preferred location:"
            echo "   ln -s \"$(readlink -f "$0")\" ~/.local/bin/$script_name"
            echo ""
        fi
    fi
}

# Detect language setting early for error messages
detect_language() {
    if [[ "$LANG" =~ ^ja ]]; then
        echo "ja"
    else
        echo "en"
    fi
}

LANG_CODE=$(detect_language)

# Detect container runtime
detect_container_runtime() {
    # Check if running on macOS and container command is available
    if [[ "$OSTYPE" == "darwin"* ]] && command -v container >/dev/null 2>&1; then
        echo "container"
    elif command -v docker >/dev/null 2>&1; then
        echo "docker"
    else
        if [ "$LANG_CODE" = "ja" ]; then
            echo "ã‚¨ãƒ©ãƒ¼: Dockerã¾ãŸã¯Container runtimeãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >&2
        else
            echo "Error: Docker or Container runtime not found" >&2
        fi
        exit 1
    fi
}

# Set container runtime command (can be overridden via environment variable)
CONTAINER_CMD="${CONTAINER_RUNTIME:-$(detect_container_runtime)}"

# Detect local timezone
detect_timezone() {
    # Use TZ environment variable if set
    if [ -n "$TZ" ]; then
        echo "$TZ"
        return
    fi
    
    # Windows (Git Bash/MSYS2) environment
    if [ -n "$MSYSTEM" ] || [ -n "$MINGW_PREFIX" ]; then
        # Get Windows timezone information
        if command -v tzutil.exe >/dev/null 2>&1; then
            local win_tz=$(tzutil.exe /g 2>/dev/null | tr -d '\r')
            # Convert Windows timezone to IANA timezone (major ones only)
            case "$win_tz" in
                "Pacific Standard Time") echo "America/Los_Angeles" ;;
                "Mountain Standard Time") echo "America/Denver" ;;
                "Central Standard Time") echo "America/Chicago" ;;
                "Eastern Standard Time") echo "America/New_York" ;;
                "GMT Standard Time") echo "Europe/London" ;;
                "Central Europe Standard Time") echo "Europe/Berlin" ;;
                "Tokyo Standard Time") echo "Asia/Tokyo" ;;
                "China Standard Time") echo "Asia/Shanghai" ;;
                "India Standard Time") echo "Asia/Kolkata" ;;
                "AUS Eastern Standard Time") echo "Australia/Sydney" ;;
                *) echo "UTC" ;;
            esac
            return
        fi
    fi
    
    # WSL environment
    if grep -qi microsoft /proc/version 2>/dev/null; then
        # WSL uses the same detection method as Linux
        if [ -f /etc/timezone ]; then
            local tz=$(cat /etc/timezone 2>/dev/null)
            if [ -n "$tz" ]; then
                echo "$tz"
                return
            fi
        fi
    fi
    
    # macOS environment
    if [ -f /etc/localtime ] && [ -L /etc/localtime ]; then
        local tz=$(readlink /etc/localtime | sed 's|/var/db/timezone/zoneinfo/||' 2>/dev/null)
        if [ -n "$tz" ]; then
            echo "$tz"
            return
        fi
    fi
    
    # Linux environment (timedatectl)
    if command -v timedatectl >/dev/null 2>&1; then
        local tz=$(timedatectl show --property=Timezone --value 2>/dev/null)
        if [ -n "$tz" ]; then
            echo "$tz"
            return
        fi
    fi
    
    # Linux environment (/etc/localtime)
    if [ -f /etc/localtime ] && [ -L /etc/localtime ]; then
        local tz=$(readlink /etc/localtime | sed 's|/usr/share/zoneinfo/||' 2>/dev/null)
        if [ -n "$tz" ]; then
            echo "$tz"
            return
        fi
    fi
    
    # Get from /etc/timezone file
    if [ -f /etc/timezone ]; then
        local tz=$(cat /etc/timezone 2>/dev/null)
        if [ -n "$tz" ]; then
            echo "$tz"
            return
        fi
    fi
    
    # Default to UTC
    echo "UTC"
}

# Detect timezone
LOCAL_TZ=$(detect_timezone)

# Parse arguments
WORKSPACE_PATH=""
CLAUDE_ARGS=""
REBUILD_CONTAINER=false
REMOVE_CONTAINER=false

# Parse our own options first
while [[ $# -gt 0 ]]; do
    case $1 in
        --rebuild-container)
            REBUILD_CONTAINER=true
            shift
            ;;
        --remove-container)
            REMOVE_CONTAINER=true
            shift
            ;;
        --)
            shift
            CLAUDE_ARGS="$@"
            break
            ;;
        *)
            # If it's a directory or ".", treat as workspace
            if [ -z "$WORKSPACE_PATH" ] && ([ -d "$1" ] || [ "$1" = "." ]); then
                WORKSPACE_PATH=$(realpath "$1")
                shift
            else
                # All remaining arguments go to Claude
                CLAUDE_ARGS="$@"
                break
            fi
            ;;
    esac
done

# If no workspace specified, use current directory
if [ -z "$WORKSPACE_PATH" ]; then
    WORKSPACE_PATH=$(pwd)
fi

# Function to display usage information
show_usage() {
    if [ "$LANG_CODE" = "ja" ]; then
        echo "ä½¿ç”¨æ–¹æ³•: claude-container [ã‚ªãƒ—ã‚·ãƒ§ãƒ³] [ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹] [-- claudeã‚ªãƒ—ã‚·ãƒ§ãƒ³...]"
        echo ""
        echo "ã‚ªãƒ—ã‚·ãƒ§ãƒ³:"
        echo "   --rebuild-container                                  # ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å†ãƒ“ãƒ«ãƒ‰"
        echo "   --remove-container                                   # ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤"
        echo ""
        echo "åŸºæœ¬çš„ãªä½¿ç”¨ä¾‹:"
        echo "   claude-container                                     # ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½¿ç”¨"
        echo "   claude-container .                                   # ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ˜Žç¤º"
        echo "   claude-container /path/to/project                    # æŒ‡å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½¿ç”¨"
        echo ""
        echo "Claudeã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»˜ãã®ä½¿ç”¨ä¾‹:"
        echo "   claude-container -- --model claude-3-opus-20240229  # ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª + claudeã‚ªãƒ—ã‚·ãƒ§ãƒ³"
        echo "   claude-container . -- --verbose                     # ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª + claudeã‚ªãƒ—ã‚·ãƒ§ãƒ³"
        echo "   claude-container /path -- --model claude-3-opus     # æŒ‡å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª + claudeã‚ªãƒ—ã‚·ãƒ§ãƒ³"
        echo "   claude-container --help                             # claudeã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
        echo ""
        echo "ã‚³ãƒ³ãƒ†ãƒŠç®¡ç†ã®ä¾‹:"
        echo "   claude-container --rebuild-container                # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å†ãƒ“ãƒ«ãƒ‰"
        echo "   claude-container --remove-container                 # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤"
    else
        echo "Usage: claude-container [options] [workspace] [-- claude-options...]"
        echo ""
        echo "Options:"
        echo "   --rebuild-container                                  # Rebuild container image"
        echo "   --remove-container                                   # Remove container image"
        echo ""
        echo "Basic usage examples:"
        echo "   claude-container                                     # Use current directory"
        echo "   claude-container .                                   # Use current directory explicitly"
        echo "   claude-container /path/to/project                    # Use specified directory"
        echo ""
        echo "Usage with Claude options:"
        echo "   claude-container -- --model claude-3-opus-20240229  # Current directory + Claude options"
        echo "   claude-container . -- --verbose                     # Current directory + Claude options"
        echo "   claude-container /path -- --model claude-3-opus     # Specified directory + Claude options"
        echo "   claude-container --help                             # Show Claude help"
        echo ""
        echo "Container management examples:"
        echo "   claude-container --rebuild-container                # Rebuild image"
        echo "   claude-container --remove-container                 # Remove image"
    fi
}

if [ ! -d "$WORKSPACE_PATH" ]; then
    if [ "$LANG_CODE" = "ja" ]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“: $WORKSPACE_PATH"
    else
        echo "Error: Directory does not exist: $WORKSPACE_PATH"
    fi
    echo ""
    show_usage
    exit 1
fi

# Check if the workspace path is actually accessible
if [ ! -r "$WORKSPACE_PATH" ]; then
    if [ "$LANG_CODE" = "ja" ]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“: $WORKSPACE_PATH"
        echo "æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
    else
        echo "Error: Cannot access directory: $WORKSPACE_PATH"
        echo "Please check permissions."
    fi
    exit 1
fi

# Docker image name
IMAGE_NAME="claude-code"

# Function to check if image exists
image_exists() {
    $CONTAINER_CMD images --format "table {{.Repository}}:{{.Tag}}" 2>/dev/null | grep -q "^$IMAGE_NAME:latest$"
}

# Function to build container image
build_image() {
    if [ "$LANG_CODE" = "ja" ]; then
        echo "ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã„ã¾ã™..."
    else
        echo "Building container image..."
    fi
    
    if [ ! -f "$SCRIPT_DIR/Dockerfile" ]; then
        if [ "$LANG_CODE" = "ja" ]; then
            echo "ã‚¨ãƒ©ãƒ¼: DockerfileãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $SCRIPT_DIR/Dockerfile"
        else
            echo "Error: Dockerfile not found: $SCRIPT_DIR/Dockerfile"
        fi
        exit 1
    fi
    
    $CONTAINER_CMD build -t "$IMAGE_NAME" "$SCRIPT_DIR"
    if [ $? -ne 0 ]; then
        if [ "$LANG_CODE" = "ja" ]; then
            echo "ã‚¨ãƒ©ãƒ¼: ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
        else
            echo "Error: Failed to build container image"
        fi
        exit 1
    fi
    
    if [ "$LANG_CODE" = "ja" ]; then
        echo "ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ"
    else
        echo "Container image build completed"
    fi
}

# Function to remove container image
remove_image() {
    if image_exists; then
        if [ "$LANG_CODE" = "ja" ]; then
            echo "ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¦ã„ã¾ã™..."
        else
            echo "Removing container image..."
        fi
        $CONTAINER_CMD rmi "$IMAGE_NAME" 2>/dev/null
        if [ "$LANG_CODE" = "ja" ]; then
            echo "ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
        else
            echo "Container image removed"
        fi
    else
        if [ "$LANG_CODE" = "ja" ]; then
            echo "ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $IMAGE_NAME"
        else
            echo "Container image not found: $IMAGE_NAME"
        fi
    fi
}

# Handle container management options
if [ "$REMOVE_CONTAINER" = true ]; then
    remove_image
    exit 0
fi

if [ "$REBUILD_CONTAINER" = true ]; then
    if image_exists; then
        remove_image
    fi
    build_image
    exit 0
fi

# Check if image exists, build if not
if ! image_exists; then
    if [ "$LANG_CODE" = "ja" ]; then
        echo "ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åˆå›žãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™..."
    else
        echo "Container image not found. Building for the first time..."
    fi
    build_image
fi

# Container name (generated from workspace path with timestamp)
TIMESTAMP=$(date +%s)
CONTAINER_NAME="claude-code-$(echo "$WORKSPACE_PATH" | sed 's/[^a-zA-Z0-9]/-/g' | tail -c 40)-$TIMESTAMP"

if [ "$LANG_CODE" = "ja" ]; then
    echo "Claude Code Container ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™..."
    echo "ã‚³ãƒ³ãƒ†ãƒŠãƒ©ãƒ³ã‚¿ã‚¤ãƒ : $CONTAINER_CMD"
    echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹: $WORKSPACE_PATH"
    echo "ã‚³ãƒ³ãƒ†ãƒŠå: $CONTAINER_NAME"
    echo "ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³: $LOCAL_TZ"
else
    echo "Starting Claude Code Container..."
    echo "Container runtime: $CONTAINER_CMD"
    echo "Workspace: $WORKSPACE_PATH"
    echo "Container name: $CONTAINER_NAME"
    echo "Timezone: $LOCAL_TZ"
fi

# Show symlink hint if running directly (not via symlink)
show_symlink_hint

# Function to cleanup container on exit
cleanup_container() {
    if [ -n "$CONTAINER_NAME" ]; then
        if [ "$LANG_CODE" = "ja" ]; then
            echo "ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ã—ã¦ã„ã¾ã™..."
        else
            echo "Stopping container..."
        fi
        $CONTAINER_CMD stop "$CONTAINER_NAME" >/dev/null 2>&1
        $CONTAINER_CMD rm "$CONTAINER_NAME" >/dev/null 2>&1
    fi
}

# Set up signal handlers to cleanup container on interruption
trap cleanup_container EXIT
trap cleanup_container INT
trap cleanup_container TERM

# Mount entire docker folder
MOUNT_OPTIONS="-v \"$SCRIPT_DIR/docker:/home/node\""

# Execute container
eval "$CONTAINER_CMD run -it --rm \
    --name \"$CONTAINER_NAME\" \
    $MOUNT_OPTIONS \
    -v \"$WORKSPACE_PATH:/workspace\" \
    -e HOME=/home/node \
    -e TZ=\"$LOCAL_TZ\" \
    --workdir /workspace \
    \"$IMAGE_NAME\" claude $CLAUDE_ARGS"

# Cleanup after normal exit
cleanup_container
