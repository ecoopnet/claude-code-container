#!/bin/bash

# Get the directory where the script is located (supports symbolic links)
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || realpath "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")")" && pwd)"

# Detect language setting early for error messages
detect_language() {
    if [[ "$LANG" =~ ^ja ]]; then
        echo "ja"
    else
        echo "en"
    fi
}

LANG_CODE=$(detect_language)

# Detect container runtime
detect_container_runtime() {
    # Check if running on macOS and container command is available
    if [[ "$OSTYPE" == "darwin"* ]] && command -v container >/dev/null 2>&1; then
        echo "container"
    elif command -v docker >/dev/null 2>&1; then
        echo "docker"
    else
        if [ "$LANG_CODE" = "ja" ]; then
            echo "エラー: DockerまたはContainer runtimeが見つかりません" >&2
        else
            echo "Error: Docker or Container runtime not found" >&2
        fi
        exit 1
    fi
}

# Set container runtime command (can be overridden via environment variable)
CONTAINER_CMD="${CONTAINER_RUNTIME:-$(detect_container_runtime)}"

# Detect local timezone
detect_timezone() {
    # Use TZ environment variable if set
    if [ -n "$TZ" ]; then
        echo "$TZ"
        return
    fi
    
    # Windows (Git Bash/MSYS2) environment
    if [ -n "$MSYSTEM" ] || [ -n "$MINGW_PREFIX" ]; then
        # Get Windows timezone information
        if command -v tzutil.exe >/dev/null 2>&1; then
            local win_tz=$(tzutil.exe /g 2>/dev/null | tr -d '\r')
            # Convert Windows timezone to IANA timezone (major ones only)
            case "$win_tz" in
                "Pacific Standard Time") echo "America/Los_Angeles" ;;
                "Mountain Standard Time") echo "America/Denver" ;;
                "Central Standard Time") echo "America/Chicago" ;;
                "Eastern Standard Time") echo "America/New_York" ;;
                "GMT Standard Time") echo "Europe/London" ;;
                "Central Europe Standard Time") echo "Europe/Berlin" ;;
                "Tokyo Standard Time") echo "Asia/Tokyo" ;;
                "China Standard Time") echo "Asia/Shanghai" ;;
                "India Standard Time") echo "Asia/Kolkata" ;;
                "AUS Eastern Standard Time") echo "Australia/Sydney" ;;
                *) echo "UTC" ;;
            esac
            return
        fi
    fi
    
    # WSL environment
    if grep -qi microsoft /proc/version 2>/dev/null; then
        # WSL uses the same detection method as Linux
        if [ -f /etc/timezone ]; then
            local tz=$(cat /etc/timezone 2>/dev/null)
            if [ -n "$tz" ]; then
                echo "$tz"
                return
            fi
        fi
    fi
    
    # macOS environment
    if [ -f /etc/localtime ] && [ -L /etc/localtime ]; then
        local tz=$(readlink /etc/localtime | sed 's|/var/db/timezone/zoneinfo/||' 2>/dev/null)
        if [ -n "$tz" ]; then
            echo "$tz"
            return
        fi
    fi
    
    # Linux environment (timedatectl)
    if command -v timedatectl >/dev/null 2>&1; then
        local tz=$(timedatectl show --property=Timezone --value 2>/dev/null)
        if [ -n "$tz" ]; then
            echo "$tz"
            return
        fi
    fi
    
    # Linux environment (/etc/localtime)
    if [ -f /etc/localtime ] && [ -L /etc/localtime ]; then
        local tz=$(readlink /etc/localtime | sed 's|/usr/share/zoneinfo/||' 2>/dev/null)
        if [ -n "$tz" ]; then
            echo "$tz"
            return
        fi
    fi
    
    # Get from /etc/timezone file
    if [ -f /etc/timezone ]; then
        local tz=$(cat /etc/timezone 2>/dev/null)
        if [ -n "$tz" ]; then
            echo "$tz"
            return
        fi
    fi
    
    # Default to UTC
    echo "UTC"
}

# Detect timezone
LOCAL_TZ=$(detect_timezone)

# Parse arguments
WORKSPACE_PATH=""
CLAUDE_ARGS=""

# Find position of --
DOUBLE_DASH_POS=-1
for i in $(seq 1 $#); do
    if [ "${!i}" = "--" ]; then
        DOUBLE_DASH_POS=$i
        break
    fi
done

if [ $DOUBLE_DASH_POS -gt 0 ]; then
    # If -- is found
    if [ $DOUBLE_DASH_POS -eq 1 ]; then
        # If first argument is --, workspace is current directory
        WORKSPACE_PATH=$(pwd)
        shift # Remove --
        CLAUDE_ARGS="$@"
    else
        # Arguments before -- are treated as workspace (first one only)
        WORKSPACE_PATH=$(realpath "$1")
        shift $DOUBLE_DASH_POS # Remove up to --
        CLAUDE_ARGS="$@"
    fi
else
    # If -- is not found
    if [ $# -eq 0 ]; then
        # No arguments: use current directory
        WORKSPACE_PATH=$(pwd)
        CLAUDE_ARGS=""
    elif [ -d "$1" ] || [ "$1" = "." ]; then
        # If first argument is a directory
        WORKSPACE_PATH=$(realpath "$1")
        shift
        CLAUDE_ARGS="$@"
    else
        # If first argument is not a directory, use current directory
        WORKSPACE_PATH=$(pwd)
        CLAUDE_ARGS="$@"
    fi
fi

# Function to display usage information
show_usage() {
    if [ "$LANG_CODE" = "ja" ]; then
        echo "使用方法: claude-container [ワークスペース] [-- claudeオプション...]"
        echo ""
        echo "基本的な使用例:"
        echo "   claude-container                                     # カレントディレクトリを使用"
        echo "   claude-container .                                   # カレントディレクトリを明示"
        echo "   claude-container /path/to/project                    # 指定ディレクトリを使用"
        echo ""
        echo "Claudeオプション付きの使用例:"
        echo "   claude-container -- --model claude-3-opus-20240229  # カレントディレクトリ + claudeオプション"
        echo "   claude-container . -- --verbose                     # カレントディレクトリ + claudeオプション"
        echo "   claude-container /path -- --model claude-3-opus     # 指定ディレクトリ + claudeオプション"
        echo "   claude-container --help                             # claudeのヘルプを表示"
    else
        echo "Usage: claude-container [workspace] [-- claude-options...]"
        echo ""
        echo "Basic usage examples:"
        echo "   claude-container                                     # Use current directory"
        echo "   claude-container .                                   # Use current directory explicitly"
        echo "   claude-container /path/to/project                    # Use specified directory"
        echo ""
        echo "Usage with Claude options:"
        echo "   claude-container -- --model claude-3-opus-20240229  # Current directory + Claude options"
        echo "   claude-container . -- --verbose                     # Current directory + Claude options"
        echo "   claude-container /path -- --model claude-3-opus     # Specified directory + Claude options"
        echo "   claude-container --help                             # Show Claude help"
    fi
}

if [ ! -d "$WORKSPACE_PATH" ]; then
    if [ "$LANG_CODE" = "ja" ]; then
        echo "エラー: ディレクトリが存在しません: $WORKSPACE_PATH"
    else
        echo "Error: Directory does not exist: $WORKSPACE_PATH"
    fi
    echo ""
    show_usage
    exit 1
fi

# Check if the workspace path is actually accessible
if [ ! -r "$WORKSPACE_PATH" ]; then
    if [ "$LANG_CODE" = "ja" ]; then
        echo "エラー: ディレクトリにアクセスできません: $WORKSPACE_PATH"
        echo "権限を確認してください。"
    else
        echo "Error: Cannot access directory: $WORKSPACE_PATH"
        echo "Please check permissions."
    fi
    exit 1
fi

# Docker image name
IMAGE_NAME="claude-code"

# Container name (generated from workspace path with timestamp)
TIMESTAMP=$(date +%s)
CONTAINER_NAME="claude-code-$(echo "$WORKSPACE_PATH" | sed 's/[^a-zA-Z0-9]/-/g' | tail -c 40)-$TIMESTAMP"

if [ "$LANG_CODE" = "ja" ]; then
    echo "Claude Code Container を起動しています..."
    echo "コンテナランタイム: $CONTAINER_CMD"
    echo "ワークスペース: $WORKSPACE_PATH"
    echo "コンテナ名: $CONTAINER_NAME"
    echo "タイムゾーン: $LOCAL_TZ"
else
    echo "Starting Claude Code Container..."
    echo "Container runtime: $CONTAINER_CMD"
    echo "Workspace: $WORKSPACE_PATH"
    echo "Container name: $CONTAINER_NAME"
    echo "Timezone: $LOCAL_TZ"
fi

# Mount entire docker folder
MOUNT_OPTIONS="-v \"$SCRIPT_DIR/docker:/home/node\""

# Execute container
eval "$CONTAINER_CMD run -it --rm \
    --name \"$CONTAINER_NAME\" \
    $MOUNT_OPTIONS \
    -v \"$WORKSPACE_PATH:/workspace\" \
    -e HOME=/home/node \
    -e TZ=\"$LOCAL_TZ\" \
    --workdir /workspace \
    \"$IMAGE_NAME\" claude $CLAUDE_ARGS"
